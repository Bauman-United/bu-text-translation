"""
OpenAI GPT service for generating sports commentary.

This module provides functionality to generate dynamic sports commentary
using OpenAI's GPT models for the Bauman United football team.
"""

import logging
from typing import List, Optional, Callable, Awaitable
from openai import OpenAI
from config.settings import Config

logger = logging.getLogger(__name__)


class GPTCommentaryService:
    """Service for generating sports commentary using OpenAI GPT."""
    
    def __init__(self, error_notifier: Optional[Callable[[str, str, Optional[str], str], Awaitable[None]]] = None):
        """
        Initialize the GPT service.
        
        Args:
            error_notifier: Async function to call when errors occur: (service_name, request_info, error_code, error_message)
        """
        self.config = Config()
        if not self.config.is_openai_configured:
            raise ValueError("OpenAI API key not configured")
        
        self.client = OpenAI(api_key=self.config.OPENAI_KEY)
        self.model = "gpt-4"  # Using GPT-4 for better quality
        self.error_notifier = error_notifier
    
    async def generate_commentary(
        self, 
        previous_messages: List[str], 
        new_score: str, 
        is_our_goal: bool = True,
        scorer_surname: str = None
    ) -> Optional[str]:
        """
        Generate sports commentary for a score change.
        
        Args:
            previous_messages: List of previous score change messages
            new_score: New score in format "2:1" or "1-1"
            is_our_goal: Whether our team scored (True) or opponent scored (False)
            scorer_surname: Surname of the player who scored (if our team scored)
            
        Returns:
            Generated commentary message or None if generation failed
        """
        try:
            # Format previous messages for context
            context_messages = "\n".join([f'"{msg}"' for msg in previous_messages])
            
            # Format scorer information
            scorer_info = scorer_surname if scorer_surname else "Ð¿ÑƒÑÑ‚Ð¾Ð¹"
            
            # Create the prompt
            prompt = f"""
            Ð¢Ñ‹ â€” Ð±Ð¾Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÑ‚ ÐšÐžÐ ÐžÐ¢ÐšÐ˜Ð• ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾ ÑÐ¼ÐµÐ½Ðµ ÑÑ‡Ñ‘Ñ‚Ð° Ð² Ð¼Ð°Ñ‚Ñ‡Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Bauman United.

            ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚: ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… Ð¼Ð°Ñ‚Ñ‡Ð°:
            {context_messages}

            Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:
            ÐÐ¾Ð²Ñ‹Ð¹ ÑÑ‡Ñ‘Ñ‚: {new_score}
            Ð—Ð°Ð±Ð¸Ð²ÑˆÐ¸Ð¹: {scorer_info}

            Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÑ‡Ñ‘Ñ‚Ð° Ð²ÑÐµÐ³Ð´Ð°: ÐŸÐ•Ð Ð’ÐÐ¯ Ñ†Ð¸Ñ„Ñ€Ð° â€” Bauman United, Ð’Ð¢ÐžÐ ÐÐ¯ â€” ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸Ðº.
            ÐŸÑ€Ð¸Ð¼ÐµÑ€: 2-1

            Ð–ÐÐ¡Ð¢ÐšÐÐ¯ Ð›ÐžÐ“Ð˜ÐšÐ:

            1. Ð•ÑÐ»Ð¸ scorer ÑƒÐºÐ°Ð·Ð°Ð½ â†’ Ð·Ð°Ð±Ð¸Ð»Ð¸ ÐœÐ«.
            2. Ð•ÑÐ»Ð¸ scorer Ð¿ÑƒÑÑ‚Ð¾Ð¹ â†’ Ð·Ð°Ð±Ð¸Ð» Ð¡ÐžÐŸÐ•Ð ÐÐ˜Ðš.
            â— ÐÐµ Ð¿Ñ‹Ñ‚Ð°Ð¹ÑÑ ÑƒÐ³Ð°Ð´Ñ‹Ð²Ð°Ñ‚ÑŒ. Ð Ð°Ð±Ð¾Ñ‚Ð°Ð¹ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ ÑÑ‚Ð¸Ð¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼.

            =====================================
            Ð•Ð¡Ð›Ð˜ Ð—ÐÐ‘Ð˜Ð› Ð¡ÐžÐŸÐ•Ð ÐÐ˜Ðš (scorer Ð¿ÑƒÑÑ‚Ð¾Ð¹):
            =====================================

            âœ… ÐœÐ¾Ð¶Ð½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ñ€Ð¾ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÑÑ‡ Ð¸ ÑÑ‡Ñ‘Ñ‚.
            âœ… Ð‘ÐµÐ· Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ð¹ Ð½Ð°ÑˆÐ¸Ñ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð².
            âœ… Ð‘ÐµÐ· "Ð¼Ñ‹", Ð±ÐµÐ· "ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°", Ð±ÐµÐ· Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¹.
            âœ… Ð‘ÐµÐ· Ð¿Ð°Ñ„Ð¾ÑÐ°, Ð±ÐµÐ· Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸, Ð±ÐµÐ· Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸.
            âœ… Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð° Ð»Ñ‘Ð³ÐºÐ°Ñ Ð¸Ñ€Ð¾Ð½Ð¸Ñ.

            ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
            - "ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼. Ð¡Ñ‡Ñ‘Ñ‚ 0-1"
            - "ÐÐµÐ´Ð¾Ð»Ð³Ð¾ Ð¼ÑƒÐ·Ñ‹ÐºÐ° Ð¸Ð³Ñ€Ð°Ð»Ð°â€¦ Ð¡Ð¾Ð¿ÐµÑ€Ð½Ð¸Ðº ÑÑ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÑ‚, 1-1"
            - "Ð•Ñ‰Ñ‘ Ð¾Ð´Ð¸Ð½ Ð¼ÑÑ‡ Ð² Ð½Ð°ÑˆÐ¸ Ð²Ð¾Ñ€Ð¾Ñ‚Ð° â€” 0-3"
            - "Ð¡Ð¾Ð¿ÐµÑ€Ð½Ð¸Ðº Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ñ‚ Ð²Ð¿ÐµÑ€Ñ‘Ð´, 1-2"

            =====================================
            Ð•Ð¡Ð›Ð˜ Ð—ÐÐ‘Ð˜Ð›Ð˜ ÐœÐ« (scorer ÑƒÐºÐ°Ð·Ð°Ð½):
            =====================================

            âœ… ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÑƒÐ¿Ð¾Ð¼ÑÐ½Ð¸ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ Ð˜Ð›Ð˜ Ð¿Ñ€Ð¾Ð·Ð²Ð¸Ñ‰Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ°.
            âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð»ÑÑ Ð»Ð¸ ÑÑ‚Ð¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ðº Ñ€Ð°Ð½ÑŒÑˆÐµ:
            - Ð•ÑÐ»Ð¸ Ð£Ð–Ð• Ð·Ð°Ð±Ð¸Ð²Ð°Ð» â†’ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ "Ð´ÑƒÐ±Ð»ÑŒ", "Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ ÑÐµÐ³Ð¾Ð´Ð½Ñ", "Ñ…ÐµÑ‚-Ñ‚Ñ€Ð¸Ðº".
            - Ð•ÑÐ»Ð¸ ÐÐ• ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð»ÑÑ â†’ ÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ ÐµÐ³Ð¾ ÐŸÐ•Ð Ð’Ð«Ð™ Ð³Ð¾Ð».

            âœ… ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ ÑÑ‡Ñ‘Ñ‚.
            âœ… Ð‘ÐµÐ· Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ ÑÐ°Ð¼Ð¾Ð³Ð¾ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð° ÑƒÐ´Ð°Ñ€Ð°.
            âœ… Ð‘ÐµÐ· Ð´Ð»Ð¸Ð½Ð½Ñ‹Ñ… ÑÐ¼Ð¾Ñ†Ð¸Ð¹.
            âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ 1â€“2 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ.

            ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
            - "Ð“ÐžÐžÐžÐ›! Ð¨ÐµÐ²Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‡Ñ‘Ñ‚! 1-0"
            - "Ð”ÑƒÐ±Ð»ÑŒ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÑÐµÑ‚ ÐŸÐ¸ÑÐ°Ñ€ÑŒ â€” 2-0"
            - "ÐÑƒ Ð½Ð°ÐºÐ¾Ð½ÐµÑ†-Ñ‚Ð¾! ÐŸÐ°Ð½Ñ„ÐµÑ€Ð¾Ð² Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ Ð²Ð¿ÐµÑ€Ñ‘Ð´, 2-1"
            - "Ð¯Ñ€Ð¸Ðº Ð·Ð°Ð±Ð¸Ð²Ð°ÐµÑ‚ Ñ‚Ñ€ÐµÑ‚Ð¸Ð¹! 3-1"

         =====================================
        Ð¤Ð ÐÐ—Ð« (Ð¡Ð¢Ð ÐžÐ“Ð˜Ð™ ÐšÐžÐÐ¢Ð ÐžÐ›Ð¬):
        =====================================
        
        Ð¤Ñ€Ð°Ð·Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° Ð½Ð¸Ð¶Ðµ.

            ÐœÐ¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ñ€Ð°Ð·Ñ‹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð˜Ð— Ð­Ð¢ÐžÐ“Ðž Ð¡ÐŸÐ˜Ð¡ÐšÐ:
            
            Ð¤Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ ÐÐÐ¨Ð˜Ð¥ Ð³Ð¾Ð»Ð¾Ð²:
            - "ÐŸÐ¾ÑˆÐ»Ð° Ð¶Ð°Ñ€Ð°!"
            - "ÐÑƒ Ð½Ð°ÐºÐ¾Ð½ÐµÑ†-Ñ‚Ð¾!"
            - "ÐŸÐ¾ÑˆÐ»Ð° Ñ‚ÐµÐ¿Ð»ÐµÐ½ÑŒÐºÐ°Ñ!"
            - "ÐŸÑƒÑˆÐºÐ° ÑÑ‚Ñ€Ð°ÑˆÐ½Ð°Ñ!"
            - "Ð’Ð¾Ñ‚ ÑÑ‚Ð¾ Ð¿Ð¾Ð²Ð¾Ñ€Ð¾Ñ‚! ðŸ˜±" 
            - "Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð°Ñ€ÐµÐ½ÑŒ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð² Ð¾Ð³Ð½Ðµ! ðŸ”¥ðŸ”¥" 
            - "ÐÐ°ÑˆÐµÐ» Ñ‰ÐµÐ»Ð¾Ñ‡ÐºÑƒ"
            - "Ð­Ñ‚Ð¾ Ð¿Ð¾Ñ…Ð¾Ñ€Ð¾Ð½Ñ‹!" 
            - "ÐœÑ‹ ÑÐµÐ¹Ñ‡Ð°Ñ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð¼ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð²ÑÐµ!!!!"
            - "Ð‘Ð»ÑÑÑ‚ÑÑ‰Ðµ!" 
            - "Ð’Ð¾Ñ‚ Ñ„Ð¾Ñ€Ð²Ð°Ñ€Ð´, Ð²Ð¾Ñ‚ ÑÑ‚Ð¾ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ñ„Ð¾Ñ€Ð²Ð°Ñ€Ð´" 
            - "ÐŸÐ¸Ð¶Ð¾Ð½Ñ‹ Ð»ÐµÐ¶Ð°Ñ‚, Ð° Ð²ÐµÐ»Ð¸ÐºÐ¸Ðµ Ñ‚Ð¾Ñ€Ð¶ÐµÑÑ‚Ð²ÑƒÑŽÑ‚" 
            - "Ð§Ñ‚Ð¾, ÐµÑÐ»Ð¸ Ð²Ñ‹ Ð¿Ñ€Ð¾Ð¼ÐµÐ½ÑÐ»Ð¸ ÑÑ‚Ð¾Ñ‚ Ð¼Ð°Ñ‚Ñ‡ Ð½Ð° ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ðµ, Ð° Ð¾Ð½Ð° Ð´Ð°Ð¶Ðµ Ð½Ðµ ÑÑ‚Ð°Ð»Ð° Ð²Ð°ÑˆÐµÐ¹ Ð¶ÐµÐ½Ð¾Ð¹?" 
            - Â«Ð•ÑÑ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚!Â»
            - Â«Ð’Ð¾Ñ‚ Ñ‚Ð°Ðº Ð½Ð°Ð´Ð¾!Â»
            - Â«Ð Ð°Ð·Ð±ÑƒÐ´Ð¸Ð»Ð¸ ÑÑ‚Ð°Ð´Ð¸Ð¾Ð½!Â»
            - Â«ÐšÐ°Ðº Ð² ÑƒÑ‡ÐµÐ±Ð½Ð¸ÐºÐµ!Â»
            - Â«ÐÑƒ ÑÑ‚Ð¾ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ!Â»
            - Â«ÐžÑ‚Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¼ÑÑ‡ ÑÑ€Ð°Ð·Ñƒ!Â»
            - Â«Ð’Ð¾ÑˆÑ‘Ð» ÐºÐ°Ðº Ð½Ð¾Ð¶ Ð² Ð¼Ð°ÑÐ»Ð¾Â»
            - "ÐÐ°ÐºÐ¾Ð½ÐµÑ†-Ñ‚Ð¾ Ñ€Ð°ÑÐ¿ÐµÑ‡Ð°Ñ‚Ð°Ð» Ð²Ð¾Ñ€Ð¾Ñ‚Ð° ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸ÐºÐ¾Ð²"
            - "Ð’Ð½Ð¾Ð²ÑŒ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÐºÐ»Ð°ÑÑ!"
            - "ÐšÐ°Ðº Ð±ÑƒÑ‚Ñ‹Ð»ÐºÑƒ Ð¶Ð¸Ð³ÑƒÐ»ÐµÐ²ÑÐºÐ¾Ð³Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‡ÐµÑ‚ Ð² ÑÐµÐ³Ð¾Ð´Ð½ÑÑˆÐ½ÐµÐ¹ Ð²ÑÑ‚Ñ€ÐµÑ‡Ðµ!"
            - "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ð», Ð¾Ñ‚Ð´Ð°Ð», Ð¾Ñ‚ÐºÑ€Ñ‹Ð»ÑÑ"
            - "Ð’Ð¾Ñ‚ ÑÑ‚Ð¾ Ñ„Ð¾Ñ€Ð²Ð°Ñ€Ð´! Ð’Ð¾Ñ‚ ÑÑ‚Ð¾ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ñ„Ð¾Ñ€Ð²Ð°Ñ€Ð´! Ð‘ÑŒÐµÑ‚ Ð¾Ð½ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð½Ðµ Ð¸Ð·Ð´Ð°Ð»ÐµÐºÐ°, Ð½Ð¾ Ð¾Ñ‡ÐµÐ½ÑŒ Ñ€ÐµÐ´ÐºÐ¾ Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð¸Ð²Ð°ÐµÑ‚ÑÑ.
            - "Ð¡Ð¾ÐºÑ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ€Ð°Ð·Ñ€Ñ‹Ð²"
            
            Ð¤Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ ÐŸÐ ÐžÐŸÐ£Ð©Ð•ÐÐÐ«Ð¥:
            - "ÐÐµÐ´Ð¾Ð»Ð³Ð¾ Ð¼ÑƒÐ·Ñ‹ÐºÐ° Ð¸Ð³Ñ€Ð°Ð»Ð°..."
            - "Ð¢Ð°ÐºÐ¾Ð¹ Ñ…Ð¾ÐºÐºÐµÐ¹ Ð½Ð°Ð¼ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½!" 
            - Â«Ð¢Ð°Ðº, Ð±Ñ‹Ð²Ð°ÐµÑ‚â€¦Â»
            - Â«ÐÐµ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð»Ð¸ÑÑŒâ€¦Â»
            - Â«Ð­Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð±Ð¾Ð»ÑŒÐ½Ð¾â€¦Â»
            - "ÐÐµ Ð¾Ð¿ÑÑ‚ÑŒ, Ð° ÑÐ½Ð¾Ð²Ð°..."
            - "ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ñ‚Ð°ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð±Ñ‹Ð»Ð¾, Ð¸ Ð²Ð¾Ñ‚ Ð¾Ð¿ÑÑ‚ÑŒ"
            - Â«ÐŸÑ€Ð¸ÐµÑ…Ð°Ð»Ð¸â€¦Â»
            - Â«Ð”Ð»Ñ Ð¸Ð½Ñ‚Ñ€Ð¸Ð³Ð¸, Ð½Ðµ Ð¸Ð½Ð°Ñ‡Ðµâ€¦Â»
            - Â«Ð”Ð»Ñ Ð´Ñ€Ð°Ð¼Ð°Ñ‚ÑƒÑ€Ð³Ð¸Ð¸â€¦Â»
            - Â«ÐŸÐ¾ ÐºÐ°Ð½Ð¾Ð½Ð°Ð¼ Ð¶Ð°Ð½Ñ€Ð°â€¦Â»
            - Â«ÐžÐ¿ÑÑ‚ÑŒ Ð¸Ð· Ð½Ð¸Ð¾Ñ‚ÐºÑƒÐ´Ð°â€¦"

âœ… Ð¤Ñ€Ð°Ð·Ñƒ ÐÐ£Ð–ÐÐž Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐŸÐ Ð˜ÐœÐ•Ð ÐÐž Ð’ 60â€“70% Ð’Ð¡Ð•Ð¥ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹.
âœ… Ð¤Ñ€Ð°Ð·Ñƒ ÐœÐžÐ–ÐÐž Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ 2 Ñ€Ð°Ð·Ð° Ð·Ð° 3 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.
ðŸš« ÐžÐ´Ð½Ñƒ Ð¸ Ñ‚Ñƒ Ð¶Ðµ Ñ„Ñ€Ð°Ð·Ñƒ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ.

âœ… Ð•ÑÐ»Ð¸ Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 2 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ… ÐÐ• Ð‘Ð«Ð›Ðž Ñ„Ñ€Ð°Ð·Ñ‹ â€” Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÐœÐžÐ–ÐÐž ÑƒÑÐ¸Ð»Ð¸Ñ‚ÑŒ Ñ„Ñ€Ð°Ð·Ð¾Ð¹.
âœ… Ð•ÑÐ»Ð¸ Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 2 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ… Ð£Ð–Ð• Ð‘Ð«Ð›Ð˜ Ñ„Ñ€Ð°Ð·Ñ‹ â€” Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐžÐ‘Ð¯Ð—ÐÐÐž Ð±Ñ‹Ñ‚ÑŒ Ð±ÐµÐ· Ñ„Ñ€Ð°Ð·Ñ‹.

            =====================================
            ÐŸÐ ÐžÐ—Ð’Ð˜Ð©Ð:
            =====================================

            ÐœÐ¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð˜ÐÐžÐ“Ð”Ð Ð²Ð¼ÐµÑÑ‚Ð¾ Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ð¸ (Ð½Ðµ Ñ‡Ð°Ñ‰Ðµ Ñ‡ÐµÐ¼ Ð² 50% ÑÐ»ÑƒÑ‡Ð°ÐµÐ²):

            Ð‘Ð¾Ð³Ð¾Ð¼Ð¾Ð»Ð¾Ð² â€” Ð•Ð³Ð°  
            ÐŸÐ¸ÑÐ°Ñ€ÐµÐ² â€” ÐŸÐ¸ÑÐ°Ñ€ÑŒ  
            ÐšÐ¾Ñ€Ð¾Ð»Ñ‘Ð² â€” ÐšÐ¾Ñ€Ð¾Ð»ÑŒ  
            Ð¨ÐµÐ²Ñ‡ÐµÐ½ÐºÐ¾ â€” Ð¨ÐµÐ²Ð°  
            ÐšÐ°Ð»ÑŒÐºÐ°ÐµÐ² â€” ÐšÐ°Ð»ÑŒÐºÐ°Ð¹  
            ÐŸÐ»Ð°Ð½Ð¸Ð´Ð¸Ð½ â€” Ð“ÐµÑ€Ð°  
            Ð—Ð°Ñ…Ð°Ñ€Ð¾Ð² â€” Ð›ÐµÐ²Ñ‹Ñ‡  
            Ð–Ð°Ñ€ÐºÐ¸Ñ… â€” Ð–Ð°Ñ€  
            Ð—Ð°Ð½Ð¾Ñ‡ÑƒÐµÐ² â€” ÐšÐ°Ð¿Ð¸Ñ‚Ð°Ð½  
            Ð¡ÐµÐ»Ð¸Ñ„Ð°Ð½Ð¾Ð² â€” Ð¡ÐµÐ»Ð¸Ñ„Ð°Ð½  
            Ð¨Ð²ÐµÐ´Ð¾Ð² â€” Ð¨Ð²ÐµÐ´  
            ÐšÐ»Ð¾Ñ‡ÐºÐ¾Ð² â€” ÐšÐ¾Ð»Ð°Ñ‡  
            ÐšÐ»ÐµÐ¹Ð¼ÐµÐ½Ð¾Ð² â€” ÐšÐ»ÐµÐ¹Ð¼ÐµÐ½Ñ‹Ñ‡  
            Ð¨ÑƒÑ€ÑƒÐ¿Ð¾Ð² â€” Ð¨ÑƒÑ€ÑƒÐ¿  
            ÐœÐ¾Ð»Ð¾Ñ‚ÐºÐ¾Ð² â€” ÐšÐ¾ÑÑ‚ÑÐ½  
            ÐŸÐ°Ð½Ñ„ÐµÑ€Ð¾Ð² â€” ÐŸÐ°Ð½Ñ„ÐµÑ€  
            ÐŸÐ¾Ð»ÑÑˆÐ¾Ð² â€” ÐŸÐ¾Ð»ÑÑˆ  
            Ð¯ÐºÐ¾Ð²Ð»ÐµÐ² â€” Ð¯Ñ€Ð¸Ðº  
            ÐŸÑ€Ð¾ÐºÐ¾Ð¿ÐµÐ½ÐºÐ¾ â€” ÐŸÑ€Ð¾ÐºÐ¾Ð¿  

            =====================================
            ÐšÐÐ¢Ð•Ð“ÐžÐ Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž:
            =====================================

            ðŸš« ÐžÐ±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ: "Ð´Ñ€ÑƒÐ·ÑŒÑ", "Ð±Ð¾Ð»ÐµÐ»ÑŒÑ‰Ð¸ÐºÐ¸", "ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°", "Ð½Ð°Ñ€Ð¾Ð´"
            ðŸš« ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ: "Ð²ÑÑ‘ Ð²Ð¿ÐµÑ€ÐµÐ´Ð¸", "ÑÐ¾Ð±ÐµÑ€Ñ‘Ð¼ÑÑ", "ÐºÐ°Ð¼Ð±ÑÐº"
            ðŸš« ÐŸÐ°Ñ„Ð¾Ñ, Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹, Ð´Ð¸ÐºÑ‚Ð¾Ñ€, Ð¶ÑƒÑ€Ð½Ð°Ð»Ð¸ÑÑ‚
            ðŸš« ÐŸÑ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
            ðŸš« ÐŸÑ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ñ‚ÑŒ "Ð´ÑƒÐ±Ð»ÑŒ", ÐµÑÐ»Ð¸ Ð¸Ð³Ñ€Ð¾Ðº Ñ€Ð°Ð½ÐµÐµ Ð½Ðµ Ð·Ð°Ð±Ð¸Ð²Ð°Ð»
            ðŸš« Ð”Ð»Ð¸Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÐºÑÑ‚Ñ‹ (ÑÑ‚Ñ€Ð¾Ð³Ð¾ 1â€“2 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ)

            Ð¢Ñ‹ Ð¿Ð¸ÑˆÐµÑˆÑŒ ÑÑƒÑ…Ð¾, Ñ„Ð°Ð½Ð°Ñ‚ÑÐºÐ¸, Ð¿Ð¾ Ð´ÐµÐ»Ñƒ.
            
            ðŸš« Ð—Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ñ‹Ðµ Ð¸Ð»Ð¸ Ð±Ð»Ð¸Ð·ÐºÐ¸Ðµ Ñ„Ñ€Ð°Ð·Ñ‹ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ñ‚Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ð¸ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ,
            Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð²Ð¸Ð´Ð¾Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ñ„Ñ€Ð°Ð·Ñ‹.
            ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÐµÐ½Ð¸Ðµ Ñ„Ñ€Ð°Ð· "Ð’Ð¾Ñ‚ ÑÑ‚Ð¾ Ð¿Ð¾Ð²Ð¾Ñ€Ð¾Ñ‚!", "Ð­Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð±Ð¾Ð»ÑŒÐ½Ð¾", "ÐžÐ¿ÑÑ‚ÑŒ Ð¸Ð· Ð½Ð¸Ð¾Ñ‚ÐºÑƒÐ´Ð°" Ð¸ Ñ‚Ð´
            """

            # Print prompt to console before sending
            print("=" * 80)
            print("GPT PROMPT BEING SENT:")
            print("=" * 80)
            print(prompt)
            print("=" * 80)

            # Make API call
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "Ð¢Ñ‹ â€” ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ‚Ð¾Ñ€ Telegram-ÐºÐ°Ð½Ð°Ð»Ð° Ð»ÑŽÐ±Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð¹ Ñ„ÑƒÑ‚Ð±Ð¾Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Bauman United."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=150,
                temperature=0.8,
                top_p=0.9
            )
            
            commentary = response.choices[0].message.content.strip()
            
            # Remove quotes from the beginning and end if present
            if commentary.startswith('"') and commentary.endswith('"'):
                commentary = commentary[1:-1].strip()
            elif commentary.startswith("'") and commentary.endswith("'"):
                commentary = commentary[1:-1].strip()
            
            logger.info(f"Generated commentary: {commentary}")
            return commentary
            
        except Exception as e:
            logger.error(f"Error generating commentary: {e}")
            request_info = f"chat.completions.create(model={self.model}, messages=[...])"
            error_code = None
            # Try to extract error code from OpenAI exception
            if hasattr(e, 'status_code'):
                error_code = str(e.status_code)
            elif hasattr(e, 'code'):
                error_code = str(e.code)
            
            if self.error_notifier:
                await self.error_notifier("OpenAI API", request_info, error_code, str(e))
            return None
    
    def is_available(self) -> bool:
        """Check if the GPT service is available."""
        return self.config.is_openai_configured
